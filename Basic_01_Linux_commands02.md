# 万万没想到，命令行也能玩数据分析？

在大数据时代，很多领域都越来越重视数据分析，越来越多的朋友也开始学习数据分析。有的朋友喜欢用图形化软件，还有很多喜欢用Python或 R写脚本进行更灵活的数据分析。但你有没有想过，其实Linux命令行也可以玩数据分析？

# AI 项目的 Linux 命令基础 (下篇)

本篇是Linux命令基础的下篇。在今天的文章里，我通过一个数据分析的实例，为大家演示一些Linux命令行下可以帮助数据分析的经典命令。今天的示例一共有两个，分别是著名的机器学习 iris 数据集，XXX。

##  iris 数据集

今天第一个示例就是 iris 数据集。该数据集里一共有 150 条记录，五个字段 。字段含义分别是花萼长度，花萼宽度，花瓣长度，花瓣宽度和鸢尾花类别（Setosa，Versicolour，Virginica ）

### 数据获取

数据从UCI 数据集上直接下载，使用命令`wget`：
```
cd /tmp
wget http://archive.ics.uci.edu/ml/machine-learning-databases/iris/iris.data
```

`wget`是Linux下最常用的下载数据的命令之一， 其通常用法是：
```
 wget -c  -t 0  xxxxx 
```
其中，`-c`表示断点续传，`-t 0`表示无限重试，在Linux下还有`curl`命令同样也可以下载数据。
> 无论是`wget`还是`curl`都只是单线程，我们可以安装其他更快的命令，比如`aria2c`或`axel`命令，都是默认支持断点续传，并能多线程下载的命令。我们可以用`apt`进行安装这些命令。但在实际中，我们看到的很多网站数据很难直接得到下载地址，一般都是通过专门的爬虫去爬取数据。**关于这部分内容，读者们可以参考学习AI派公众号的爬虫专栏系列文章。**

### 文件操作

- 移动/重命名
使用`mv`命令：
```
mv file1 file2 dir  # 将file1和file2 移动到dir下
mv dir1 dir2 # 如果dir2不存在，则表示目录重命名
mv file1 file2 # file2存在时会覆盖file2；否则，会重命名file1为file2
```
- 复制文件/文件夹
使用`cp`命令
```
cp file1 file2 # 将file1复制为file2
cp -r dir1/*    dir2/  将dir1目录下的所有内容复制到dir2目录下
cp -r dir1   dir3   将dir1目录整个复制为dir3（含所有文件和子文件夹）
```
>复制文件夹内部内容，经常需要`-r`参数

- 删除文件或文件夹
Linux下的命令是`rm`，**特别注意大部分情况无法撤销`rm`的删除**。传说中的破坏力极大的命令：
```
rm -rf xxxx
```
> 上述表示强制删除xxx和xxx下的所有文件夹和子目录，生产环境里面**用不好就等于删库跑路，一定要谨慎**。

- 创建文件夹
命令是`mkdir`，在工作中常用到建立好几级的目录结构，比如：
```
mkdir -p data/raw
```
参数`-p`的优点是，在`data`，`raw`目录均不存在时，命令可以直接创建这些目录，而不需要挨个创建。

### 数据检查

- 打印/拼接

获取数据后，第一步是检查数据，简单说是显示数据里的内容。我们这里介绍这些命令主要是处理文本类型的数据，所以显示数据就是打印文本文件。读者很容易想到用`cat`打印，通过该命令能打印一个csv文件里的全部信息：
```
cat data.csv
```
另外，`cat`还有拼接文件的功能，可以用`cat`快速实现两个csv的拼接:
```
cat data1.csv data2.csv > data_all.csv
```
或者是csv数据的添加：
```
cat newdata.csv >>  data_all.csv
```
- 交互式检查

如果文件行数很多，`cat`会导致刷屏。这时，**`cat`结果更多是作为管道符的一个输入，传递给后续命令进行筛选或处理，**而不是直接显示出来。如果真的想检索所有数据，Linux有一个`less`命令，可以实现快捷的交互式数据检查：
```
less -S iris.data
```
这里的`less`会显示一个交互式的可操作文本界面。内容是文件的所有内容，我们使用键盘上的方向键可以上下观察，发现该数据是一个**没有表头**的逗号分隔的数据表格文件。注意`-S`参数，对数据分析很有用。**该参数保证数据文件的每行内容不会随终端窗口的宽度限制而换行**，让我们不会混淆数据行的位置。
> 在大数据量的初步检查时，`less`更能体现出其作用。因为**`less`不会将所有数据一次性都读入内存**；此外，在`less`返回的操作界面中，还可以直接使用vim的方向操作键位。比如`ijkl`的四方向操作，以及`shift+G` 和 `gg` 的快捷操作，如果有不知道作用的同学可以亲自试验一下。**在Linux中，很多命令的结果操作，都支持vim键位。**从中我们也可以感受到，在Linux或Unix中，这些小的技术点都是互相联系浑然一体，而不是像Windows那样，大部分都是孤立并很容易废弃。

### 数据筛选

#### 行筛选

- 头部行筛选

数据筛选操作中，最常见的是查看前几条记录。假设数据下载位置就是当前目录，可以用命令`head`查看数据中前5条记录:
```
head -n 5 iris.data
```
返回结果：
```
5.1,3.5,1.4,0.2,Iris-setosa
4.9,3.0,1.4,0.2,Iris-setosa
4.7,3.2,1.3,0.2,Iris-setosa
4.6,3.1,1.5,0.2,Iris-setosa
5.0,3.6,1.4,0.2,Iris-setosa
```
- 尾部行筛选

也可以查看数据中最后5条记录：
```
tail -n 5 iris.data
```
返回结果：
```
6.3,2.5,5.0,1.9,Iris-virginica
6.5,3.0,5.2,2.0,Iris-virginica
6.2,3.4,5.4,2.3,Iris-virginica
5.9,3.0,5.1,1.8,Iris-virginica
```
> 熟悉Python或R的同学们，可能会觉得对这两条命令觉得眼熟，因为pandas和R里都有`head`和`tail`函数，起到的作用也是一样。**Python和R还有许许多多与Linux保持一致的细节（比如路径分隔符，注释），如果你只用或只熟悉Windows是很难了解这些内容的。

- 指定行筛选

我们想只显示特定的一行，比如显示第5行记录：
```
sed -n 5p iris.data 
```
返回结果：
```
5.0,3.6,1.4,0.2,Iris-setosa
```
如果，我们想显示从A行到第B行的数据，比如从第1行到第3行数据：
```
sed -n 1,3p iris.data
```
返回结果为
```
5.1,3.5,1.4,0.2,Iris-setosa
4.9,3.0,1.4,0.2,Iris-setosa
4.7,3.2,1.3,0.2,Iris-setosa
```
通过`sed`，很容易实现`head`相同的效果。另外，`sed`可以显示多个指定行，比如显示前3行数据还可以用下面的命令：
```
sed -n -e 1p -e 2p -e 3p  iris.data
```
从结果可以发现，这里实际是显示了第1行，第2行和第3行数据。

- 随机行筛选

在数据分析中，我们经常需要对数据进行随机打乱顺序的操作。并且可能需要随机取出几条数据，这时可利用`shuf`命令完成。比如，我们想用Linux命令直接从数据中随机抽取3行记录：
```
shuf -n 3 iris.data
```
返回的记录为（**因为是随机，每次都不同**）：
```
6.4,2.8,5.6,2.1,Iris-virginica
5.0,3.5,1.3,0.3,Iris-setosa
4.6,3.1,1.5,0.2,Iris-setosa
```
- 行统计
Linux中可以使用`wc`命令统计csv中的数据记录数：
```
wc -l iris.data
```
其中，`-l`表示统计的行数。但这条命令返回的行数多算了一个空行，我们可以利用以下的复合命令，统计不含空行的行数：
```
cat iris.data | sed -e '/^$/d' | wc -l   
```
这里，`^\s*$ `匹配 空行、空格、tab。也可以使用`grep`实现同样效果：
```
cat iris.data | grep -v ^$|wc -l 
```

#### 列筛选

- 显示列名

```
cat iris.csv |  sed -e 's/,/\n/g;q'
```
这里通过`sed`命令，将第一行的逗号都替换为换行。注意，**`sed`是逐行执行**，不加后面的`;q`，会继续处理表头之外的其余行。命令返回csv表头的字段名：
```
sepal_length
sepal_width
petal_length
petal_width
species
```

- 指定列筛选

Linux的`cut`命令，原本是用于文本分割。我们这里灵活运用，将`cut`用于筛选显示csv中第几列的数据。例如，用`cut`命令显示`iris.data`的第5列类型：
```
cut -d ',' -f 5 iris.data
```
命令返回了类型。
>这里灵活运用了逗号分隔符。逗号分隔符常用于csv中。如果我们拿到一个数据是csv文件，或文件是用逗号分割的文本格式，我们就可以直接使用这条命令查看某列信息，节省了很多调用Python或R的时间。

由于上面的`cut`是全部打印了所有行，命令行被刷屏了。我们结合上一篇文章所讲的管道，和本篇文章前面所介绍的`head`组合使用：
```
cut -d ',' -f 5 iris.data | head -n 3
```
命令则只返回了我们想要的前3行第5列：
```
Iris-setosa
Iris-setosa
Iris-setosa
```

- 字段唯一值

数据分析中经常要查看某字段的唯一值，你可能马上想到pandas的`unique`函数。Linux里也有`uniq`能实现类似效果，比如我们想查看第5列的唯一值：
```
cut -d ',' -f 5 iris.data  | uniq
```
- 搜索字段内容所在行

如果想查找`data.csv`中特定值在第几行，可以用：
```
grep -rn iris.data -e "Iris-setosa"
```
结果会返回`iris.data`含有`Iris-setosa`的每一行内容和行号，高亮显示搜索的关键词`Iris-setosa`。上面的`iris.data`也可以换成通配符，比如`*.csv`,**实现多文件的内容搜索**。

> 我们可以使用更强大的文本处理命令`awk`来完成更多的文本处理操作。当然`awk`相对也更复杂一些，几乎可以看成是一个独立的编程语言。

### 数据转换

- 添加表头

我们发现，下载的数据和通常看到的csv不同，第一行是数据，不是表头。直接操作这样的数据，我们需要记忆每个字段的索引位置。我们也可以通过拼接操作，为数据增加一行表头。假设我们知道字段名分别是`sepal_length`,`sepal_width`,`petal_length`,`petal_width`和`species`，可以利用`cat`将表头和数据拼接起来：
```
echo "sepal_length,sepal_width,petal_length,petal_width,species" | cat -  iris.data  >  iris.csv
```
这里的`cat -` 部分是把管道符前面的打印内容和后面的`iris.data`进行拼接，然后利用重定向符`>`输出到文件`iris..csv`。

- 列统计

已经有表头的数据，可以利用以下命令统计列数：
```
head -1 myfile.csv | sed 's/[^,]//g' | wc -c
```
这里通过sed命令，将`head`的结果过滤为字段分隔符`,`， 然后利用`wc`统计字符个数。特别注意，**这里因为正好多统计了换行，所以恰好等于字段个数**。
> 可能有的读者会不理解，明明直接用`head`一目了然多少列，为什么还要用命令去数。其实，在实际数据分析中拿到的数据，经常有几十个字段名，有些代码中需要知道列的个数，这时快速统计列数就很有用。

- 列排序

Linux下的排序命令是`sort`，可以用`sort`对数据第1列的大小进行排序：
```
sort -t , -k 1  iris.data | head
```
这里的`-t ,`表示用逗号作为字段的分隔符。

- 数据连接

了解数据分析的同学一定知道数据库中`left join`的作用。Linux下可用`join`命令实现类似逻辑。首先，先新建一个新文件`iris_key.csv`:
```
Iris-setosa,1
```
再利用上面介绍的`sort`命令做`join`的预处理。这里，因为使用类型字段进行连接，所以排序的字段也是类型字段：
```
 sort -t , -k 5  iris.data > iris_sorted.csv 
 sort -t , iris_types.csv  > iristype_sorted.csv
 join -t , iris_sorted.csv iristype_sorted.csv -1 5 -2 1 > testjoin.csv
```
第一条`sort`命令的`-k 5`表示按照第5行进行排序。第二条是因为待排序文件本身就只有一条，所以没有指定排序字段。第三条的`join`参数`-1 5`表示，第一个待连接的数据` iris_sorted.csv`使用第5列，`-2 1`表示第二个数据`iristype_sorted.csv`使用第1列。
> `join`可实现很多SQL中类似的效果，具体可查询命令帮助`join --help`

## 参考资源

- [命令行中的数据科学](https://www.datascienceatthecommandline.com)
- [鳥哥的 Linux 私房菜](http://linux.vbird.org/) 

-----------------------------------

上次的视频彩蛋为大家展示了Linux桌面的酷炫效果，但如果